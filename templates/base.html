{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}üç™ Dulce Bias - Las M√°s Deliciosas de Chile{% endblock %}</title>
    <meta name="description" content="{% block description %}Galletas artesanales premium hechas con ingredientes naturales chilenos. Env√≠o gratis en Santiago y regiones. ¬°Prueba nuestras 15+ variedades irresistibles!{% endblock %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    <link rel="apple-touch-icon" href="{% static 'favicon.svg' %}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- Button Fix CSS -->
    <link rel="stylesheet" href="{% static 'css/button_fix.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Announcement Bar -->
    <div class="announcement-bar">
        <div class="announcement-content">
            <i class="fas fa-shipping-fast"></i>
            <span>üî• ENV√çO GRATIS en compras mayores a $15.000 | Entrega en Santiago y V Regi√≥n</span>
            <i class="fas fa-times announcement-close"></i>
        </div>
    </div>

    <!-- Financial Info Bar (solo para usuarios autenticados) -->
    {% if user.is_authenticated %}
    <div class="financial-info-bar">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-auto">
                    <div class="financial-stats">
                        <div class="stat-item">
                            <i class="fas fa-chart-line text-success"></i>
                            <span class="stat-label">Total gastado:</span>
                            <span class="stat-value">{{ user_total_spent }}</span>
                        </div>
                        <div class="stat-divider">|</div>
                        <div class="stat-item">
                            <i class="fas fa-shopping-cart text-primary"></i>
                            <span class="stat-label">Carrito actual:</span>
                            <span class="stat-value">{{ cart_total }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <a href="{% url 'shop:home' %}" class="text-decoration-none">
                        <div class="logo-container">
                            <div class="logo-icon">
                                <span class="logo-text-main">dulce</span>
                                <span class="logo-text-secondary">bias</span>
                                <div class="logo-heart">üíô</div>
                            </div>
                        </div>
                        <div class="logo-subtitle-container">
                            <span class="logo-subtitle">Premium Artesanal</span>
                        </div>
                    </a>
                </div>
                
                <div class="nav-right">
                    <ul class="nav-menu">
                        <li><a href="{% url 'shop:home' %}">Inicio</a></li>
                        <li><a href="{% url 'shop:product_list' %}">Productos</a></li>
                        <li><a href="#testimonios">Rese√±as</a></li>
                        <li><a href="{% url 'support:home' %}">Soporte</a></li>
                        <li><a href="#contacto">Contacto</a></li>
                    </ul>
                    
                    <div class="nav-actions">
                        {% if user.is_authenticated %}
                            <div class="dropdown">
                                <button class="user-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="user-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="user-info">
                                        <span class="user-name">{{ user.profile.display_name|default:user.username }}</span>
                                        <small class="user-status">En l√≠nea</small>
                                    </div>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li class="dropdown-header">
                                        <div class="user-header">
                                            <i class="fas fa-user-circle"></i>
                                            <div>
                                                <strong>{{ user.profile.display_name|default:user.username }}</strong>
                                                <small class="d-block text-muted">{{ user.email }}</small>
                                            </div>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">
                                        <i class="fas fa-user me-2"></i>Mi Perfil
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'cart:my_cart' %}">
                                        <i class="fas fa-shopping-cart me-2"></i>Mi Carrito
                                        {% if user.is_authenticated %}
                                            {% with user.cart as user_cart %}
                                                {% if user_cart.total_items > 0 %}
                                                    <span class="badge bg-primary ms-2">{{ user_cart.total_items }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'orders:order_list' %}">
                                        <i class="fas fa-box me-2"></i>Mis Pedidos
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'support:ticket_list' %}">
                                        <i class="fas fa-life-ring me-2"></i>Mis Tickets de Soporte
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'accounts:wishlist' %}">
                                        <i class="fas fa-heart me-2"></i>Lista de Deseos
                                    </a></li>
                                    {% if user.is_superuser %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="dropdown-header">
                                            <small class="text-warning fw-bold">
                                                <i class="fas fa-crown me-1"></i>Gesti√≥n Empresarial
                                            </small>
                                        </li>
                                        <li><a class="dropdown-item admin-item bg-gradient-primary text-white fw-bold" href="{% url 'management:dashboard' %}">
                                            <i class="fas fa-tachometer-alt me-2"></i>
                                            Panel Empresarial
                                        </a></li>
                                        <li><a class="dropdown-item admin-item" href="{% url 'management:stock_management' %}">
                                            <i class="fas fa-boxes me-2"></i>
                                            Control de Stock
                                        </a></li>
                                        <li><a class="dropdown-item admin-item" href="{% url 'management:supplier_management' %}">
                                            <i class="fas fa-truck me-2"></i>
                                            Proveedores
                                        </a></li>
                                        <li><a class="dropdown-item admin-item" href="{% url 'management:reports' %}">
                                            <i class="fas fa-chart-line me-2"></i>
                                            Reportes
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="dropdown-header">
                                            <small class="text-muted fw-bold">
                                                <i class="fas fa-tools me-1"></i>Admin Legacy
                                            </small>
                                        </li>
                                        <li><a class="dropdown-item admin-item" href="{% url 'orders:admin_management' %}">
                                            <i class="fas fa-cogs me-2"></i>
                                            Admin Pedidos
                                        </a></li>
                                        <li><a class="dropdown-item admin-item" href="{% url 'support:admin_management' %}">
                                            <i class="fas fa-headset me-2"></i>
                                            Admin Soporte
                                        </a></li>
                                        <li><a class="dropdown-item admin-item" href="{% url 'admin:index' %}">
                                            <i class="fas fa-database me-2"></i>
                                            Admin Principal
                                        </a></li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item logout-item" href="{% url 'accounts:logout' %}">
                                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                                    </a></li>
                                </ul>
                            </div>
                        {% else %}
                            <a href="{% url 'accounts:login' %}" class="login-btn">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>Ingresar</span>
                            </a>
                        {% endif %}
                        
                        <button class="search-btn" aria-label="Buscar" data-bs-toggle="collapse" data-bs-target="#searchForm">
                            <i class="fas fa-search"></i>
                        </button>
                        
                        <button class="wishlist-btn" aria-label="Lista de deseos">
                            <i class="far fa-heart"></i>
                            <span class="wishlist-count">{{ user.wishlist.items.count|default:0 }}</span>
                        </button>
                        
                        <a href="{% url 'cart:cart_detail' %}" class="cart-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-text d-none d-md-inline">Carrito</span>
                            <span class="cart-count">{{ cart_items_count|default:0 }}</span>
                            <span class="cart-total-preview d-none d-lg-inline">{{ cart_total|default:"$0" }}</span>
                        </a>
                    </div>
                </div>
                
                <!-- Formulario de b√∫squeda -->
                <div class="collapse search-collapse" id="searchForm">
                    <div class="search-container py-3">
                        <div class="container">
                            <div class="row justify-content-center">
                                <div class="col-lg-8 col-md-10">
                                    <form method="GET" action="{% url 'shop:search' %}" class="search-form-header">
                                        <div class="input-group search-input-group">
                                            <input type="text" 
                                                   class="form-control search-input-header" 
                                                   name="q" 
                                                   placeholder="Buscar galletas, categor√≠as, ingredientes..."
                                                   aria-label="Buscar productos"
                                                   required>
                                            <button class="btn search-submit-btn-header" type="submit">
                                                <i class="fas fa-search me-1"></i>
                                                Buscar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="mobile-menu-btn" data-bs-toggle="collapse" data-bs-target="#mobileMenu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            
            <!-- Mobile Menu -->
            <div class="collapse" id="mobileMenu">
                <div class="mobile-menu-content">
                    <a href="{% url 'shop:home' %}">Inicio</a>
                    <a href="{% url 'shop:product_list' %}">Productos</a>
                    
                    <!-- B√∫squeda m√≥vil -->
                    <div class="mobile-search-container">
                        <form method="GET" action="{% url 'shop:search' %}" class="mobile-search-form">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control mobile-search-input" 
                                       name="q" 
                                       placeholder="Buscar productos..."
                                       aria-label="Buscar productos">
                                <button class="btn mobile-search-btn" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <a href="{% url 'cart:cart_detail' %}" class="mobile-cart-link">
                        <i class="fas fa-shopping-cart me-2"></i>Carrito 
                        <span class="badge bg-primary">{{ cart_items_count|default:0 }}</span>
                    </a>
                    <a href="{% url 'support:home' %}">Soporte</a>
                    <a href="#testimonios">Rese√±as</a>
                    <a href="#contacto">Contacto</a>
                    {% if user.is_authenticated %}
                        <a href="{% url 'accounts:profile' %}">Mi Perfil</a>
                        <a href="{% url 'orders:order_list' %}">Mis Pedidos</a>
                        {% if user.is_superuser %}
                            <a href="{% url 'orders:admin_management' %}" class="text-warning">
                                <i class="fas fa-cogs me-2"></i>Admin Pedidos
                            </a>
                        {% endif %}
                        <a href="{% url 'accounts:logout' %}">Cerrar Sesi√≥n</a>
                    {% else %}
                        <a href="{% url 'accounts:login' %}">Ingresar</a>
                        <a href="{% url 'accounts:register' %}">Registrarse</a>
                    {% endif %}
                </div>
            </div>
        </nav>
    </header>

    <!-- Messages -->
    {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                {% if message.tags == 'error' %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {% elif message.tags == 'warning' %}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {% elif message.tags == 'success' %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                {% elif message.tags == 'info' %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                {% else %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                {% endif %}
                    <i class="fas fa-{% if message.tags == 'error' or message.tags == 'danger' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <div class="footer-logo-container">
                            <span class="footer-logo-text-main">dulce</span>
                            <span class="footer-logo-text-secondary">bias</span>
                            <div class="footer-logo-heart">üíô</div>
                        </div>
                        <p>Las galletas m√°s deliciosas de Chile, hechas con amor y pasi√≥n.</p>
                    </div>
                    <div class="footer-social">
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-tiktok"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Productos</h4>
                    <ul>
                        <li><a href="{% url 'shop:product_list' %}?category=classic">Galletas Cl√°sicas</a></li>
                        <li><a href="{% url 'shop:product_list' %}?category=premium">Galletas Premium</a></li>
                        <li><a href="{% url 'shop:product_list' %}?category=healthy">Galletas Saludables</a></li>
                        <li><a href="{% url 'shop:product_list' %}?category=bestseller">M√°s Vendidas</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Ayuda</h4>
                    <ul>
                        <li><a href="{% url 'support:home' %}">Centro de Soporte</a></li>
                        <li><a href="{% url 'support:faq_list' %}">Preguntas Frecuentes</a></li>
                        <li><a href="{% url 'support:quick_support' %}">Chat con IA</a></li>
                        <li><a href="#">Pol√≠tica de Env√≠os</a></li>
                        <li><a href="#">Pol√≠tica de Devoluciones</a></li>
                        <li><a href="#">T√©rminos y Condiciones</a></li>
                        <li><a href="#">Pol√≠tica de Privacidad</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Contacto</h4>
                    <ul class="contact-list">
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Avenida Brasil #1234, Valpara√≠so</span>
                        </li>
                        <li>
                            <i class="fas fa-phone"></i>
                            <span>+56 9 8765 4321</span>
                        </li>
                        <li>
                            <i class="fas fa-envelope"></i>
                            <span>info@dulcesbias.com</span>
                        </li>
                        <li>
                            <i class="fas fa-clock"></i>
                            <span>Lun-Vie: 9:00-18:00</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <p>&copy; 2024 Dulces Bias. Todos los derechos reservados.</p>
                    <div class="footer-certifications">
                        <span class="cert-badge">
                            <i class="fas fa-shield-alt"></i>
                            SSL Seguro
                        </span>
                        <span class="cert-badge">
                            <i class="fas fa-award"></i>
                            Certificado Calidad
                        </span>
                        <span class="cert-badge">
                            <i class="fas fa-leaf"></i>
                            100% Natural
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Enhanced Shopping Cart Modal -->
    <div id="cart-modal" class="modal">
        <div class="modal-content cart-modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-shopping-cart"></i>
                    Tu Carrito
                </h2>
                <button class="close-btn" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="cart-body">
                <div id="cart-items" class="cart-items-container">
                    <!-- Cart items will be inserted here -->
                </div>
                
                <div class="cart-empty" id="cart-empty" style="display: none;">
                    <div class="empty-cart-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3>Tu carrito est√° vac√≠o</h3>
                    <p>¬°Agrega algunas galletas deliciosas!</p>
                    <button class="continue-shopping-btn">Continuar Comprando</button>
                </div>
            </div>
            
            <div class="cart-footer" id="cart-footer">
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">$0</span>
                    </div>
                    <div class="summary-row">
                        <span>Env√≠o:</span>
                        <span id="shipping-cost">GRATIS</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span id="cart-total-final">$0</span>
                    </div>
                </div>
                
                <div class="cart-actions">
                    <button class="continue-shopping">
                        <i class="fas fa-arrow-left"></i>
                        Seguir Comprando
                    </button>
                    <a href="{% url 'cart:checkout' %}" class="checkout-btn">
                        <i class="fas fa-credit-card"></i>
                        Proceder al Pago
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Acceso R√°pido al Carrito -->
    <div class="modal fade" id="quickAccessModal" tabindex="-1" aria-labelledby="quickAccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="quickAccessModalLabel">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        ¬°Producto agregado al carrito!
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="quick-access-content">
                        <div class="product-added mb-3">
                            <div class="d-flex align-items-center">
                                <img id="modalProductImage" src="" alt="" class="quick-product-img me-3">
                                <div class="flex-grow-1">
                                    <h6 id="modalProductName" class="mb-1"></h6>
                                    <p id="modalProductPrice" class="text-muted mb-1"></p>
                                    <small id="modalProductQuantity" class="text-secondary"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="cart-summary-quick mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Total items en carrito:</span>
                                <span id="modalCartTotalItems" class="fw-bold"></span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Total carrito:</span>
                                <span id="modalCartTotal" class="fw-bold text-primary"></span>
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <div class="row g-2">
                                <div class="col-6">
                                    <a href="{% url 'cart:cart_detail' %}" class="btn btn-outline-primary w-100 quick-action-btn">
                                        <i class="fas fa-shopping-cart me-2"></i>
                                        Ver Carrito
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="{% url 'cart:checkout' %}" class="btn btn-success w-100 quick-action-btn">
                                        <i class="fas fa-credit-card me-2"></i>
                                        Finalizar Compra
                                    </a>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-outline-secondary w-100 quick-action-btn" data-bs-dismiss="modal">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Seguir Comprando
                                    </button>
                                </div>
                                <div class="col-6">
                                    <a href="{% url 'shop:product_list' %}" class="btn btn-outline-info w-100 quick-action-btn">
                                        <i class="fas fa-search me-2"></i>
                                        Ver M√°s Productos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n Flotante de Carrito -->
    <div class="floating-cart-btn">
        <a href="{% url 'cart:cart_detail' %}" class="floating-cart-link" title="Ver Carrito">
            <i class="fas fa-shopping-cart"></i>
            <span class="floating-cart-count">{{ cart_items_count|default:0 }}</span>
        </a>
    </div>

    <!-- jQuery (para compatibilidad con algunos componentes) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced User Dropdown Functionality
            const userBtn = document.querySelector('.user-btn');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            
            if (userBtn && dropdownMenu) {
                // Initialize Bootstrap dropdown
                const dropdown = new bootstrap.Dropdown(userBtn);
                
                // Add click animation
                userBtn.addEventListener('click', function() {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                        dropdown.hide();
                    }
                });
                
                // Keyboard navigation support
                userBtn.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        dropdown.toggle();
                    }
                });
            }
            
            // Add ripple effect to dropdown items
            const dropdownItems = document.querySelectorAll('.dropdown-item');
            dropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        });
    </script>
    
    <!-- Connectivity Check -->
    <script src="{% static 'js/connectivity-check.js' %}"></script>
    
    <!-- Custom JS -->
    <script src="{% static 'js/script.js' %}"></script>
    
    <!-- Enhanced Navigation Script - FIXED PERMANENTE -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const navbar = document.querySelector('.navbar');
        const searchBtn = document.querySelector('.search-btn');
        const searchForm = document.getElementById('searchForm');
        const body = document.body;
        const announcementBar = document.querySelector('.announcement-bar');
        const financialBar = document.querySelector('.financial-info-bar');
        
    document.addEventListener('DOMContentLoaded', function() {
        const navbar = document.querySelector('.navbar');
        const searchBtn = document.querySelector('.search-btn');
        const searchForm = document.getElementById('searchForm');
        const body = document.body;
        const announcementBar = document.querySelector('.announcement-bar');
        const financialBar = document.querySelector('.financial-info-bar');
        
        // Configurar navbar de manera que no tape contenido
        if (navbar) {
            // Agregar padding al body para compensar el navbar fijo
            const navbarHeight = navbar.offsetHeight + 80; // altura navbar + barras
            body.style.paddingTop = navbarHeight + 'px';
            
            // Forzar posici√≥n fija permanente
            navbar.style.position = 'fixed';
            navbar.style.zIndex = '1000';
            
            // Configurar posici√≥n inicial
            if (financialBar) {
                navbar.style.top = '80px'; // announcement (44px) + financial (36px)
            } else {
                navbar.style.top = '44px'; // solo announcement
            }
            
            // Manejar el scroll para efectos visuales (sin mover navbar)
            let lastScrollTop = 0;
            let ticking = false;
            
            function updateNavbar() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 100) {
                    // Al hacer scroll, solo agregar efectos visuales
                    navbar.classList.add('scrolled');
                    
                    // Ocultar announcement bar pero mantener navbar fijo
                    if (announcementBar) {
                        announcementBar.style.transform = 'translateY(-100%)';
                        // Mover navbar hacia arriba cuando se oculta announcement
                        if (financialBar) {
                            navbar.style.top = '36px'; // solo financial bar
                            body.style.paddingTop = (navbar.offsetHeight + 36) + 'px';
                        } else {
                            navbar.style.top = '0px'; // sin barras
                            body.style.paddingTop = navbar.offsetHeight + 'px';
                        }
                    }
                } else {
                    // Al volver arriba, mostrar announcement bar
                    navbar.classList.remove('scrolled');
                    
                    if (announcementBar) {
                        announcementBar.style.transform = 'translateY(0)';
                        // Restaurar posici√≥n original del navbar
                        if (financialBar) {
                            navbar.style.top = '80px';
                            body.style.paddingTop = (navbar.offsetHeight + 80) + 'px';
                        } else {
                            navbar.style.top = '44px';
                            body.style.paddingTop = (navbar.offsetHeight + 44) + 'px';
                        }
                    }
                }
                
                lastScrollTop = scrollTop;
                ticking = false;
            }
            
            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateNavbar);
                    ticking = true;
                }
            }
            
            window.addEventListener('scroll', requestTick);
            
            // Revisar posici√≥n cada segundo para asegurar que est√© fijo
            setInterval(function() {
                if (navbar.style.position !== 'fixed') {
                    navbar.style.position = 'fixed';
                    navbar.style.zIndex = '1000';
                }
            }, 1000);
        }
        
        // Mejorar comportamiento del formulario de b√∫squeda
        if (searchBtn && searchForm) {
            searchBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Toggle del formulario de b√∫squeda
                const isShown = searchForm.classList.contains('show');
                
                if (!isShown) {
                    // Mostrar formulario
                    const bsCollapse = new bootstrap.Collapse(searchForm, {
                        toggle: true
                    });
                    
                    // Focus en el input cuando se abre
                    setTimeout(() => {
                        const searchInput = searchForm.querySelector('.search-input-header');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }, 300);
                } else {
                    // Ocultar formulario
                    const bsCollapse = bootstrap.Collapse.getInstance(searchForm);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                }
            });
            
            // Cerrar formulario con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && searchForm.classList.contains('show')) {
                    const bsCollapse = bootstrap.Collapse.getInstance(searchForm);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                }
            });
            
            // Cerrar formulario al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!searchForm.contains(e.target) && !searchBtn.contains(e.target) && searchForm.classList.contains('show')) {
                    const bsCollapse = bootstrap.Collapse.getInstance(searchForm);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                }
            });
        }
        
        // Smooth scroll behavior - ajustado para navbar fijo
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    // Calcular offset din√°mico basado en la altura del navbar y barras
                    let offset = 120;
                    if (financialBar && window.getComputedStyle(financialBar).display !== 'none') {
                        offset += 40;
                    }
                    if (announcementBar && announcementBar.style.transform !== 'translateY(-100%)') {
                        offset += 44;
                    }
                    
                    const offsetTop = target.offsetTop - offset;
                    window.scrollTo({
                        top: offsetTop,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Fix dropdown scroll propagation issue
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            dropdown.addEventListener('wheel', function(e) {
                // Prevent scroll propagation to page if dropdown is scrollable
                const isScrollable = this.scrollHeight > this.clientHeight;
                if (isScrollable) {
                    e.stopPropagation();
                    
                    // Handle scroll boundaries
                    const atTop = this.scrollTop === 0;
                    const atBottom = this.scrollTop >= (this.scrollHeight - this.clientHeight);
                    
                    if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
                        e.preventDefault();
                    }
                }
            });
            
            // Also prevent touch scroll propagation on mobile
            dropdown.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            });
            
            dropdown.addEventListener('touchmove', function(e) {
                e.stopPropagation();
            });
        });
    });
    </script>
    
    <!-- Script de diagn√≥stico del carrito -->
    <script src="{% static 'js/cart-diagnostics.js' %}"></script>
    <script src="{% static 'js/cart-monitor.js' %}"></script>
    
    <!-- Script de reparaci√≥n del bot√≥n del carrito -->
    <script src="{% static 'js/cart-button-fix.js' %}"></script>
    
    <!-- Datos del usuario para JavaScript -->
    <script>
        document.body.dataset.userAuthenticated = '{{ user.is_authenticated|yesno:"true,false" }}';
    </script>
    
    <!-- Auto-dismiss alerts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Funci√≥n para cerrar alertas de forma segura
            function dismissAlert(alert) {
                if (!alert || !alert.parentNode) return;
                
                // Agregar clase para animaci√≥n de salida
                alert.classList.add('alert-dismissing');
                
                // Remover el elemento despu√©s de la animaci√≥n
                setTimeout(function() {
                    if (alert && alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }
            
            // Configurar auto-dismiss y eventos de cierre
            const alerts = document.querySelectorAll('.messages-container .alert');
            
            alerts.forEach(function(alert) {
                if (!alert) return;
                
                // Auto-dismiss despu√©s de 5 segundos
                setTimeout(function() {
                    dismissAlert(alert);
                }, 5000);
                
                // Manejar cierre manual con el bot√≥n X
                const closeBtn = alert.querySelector('.btn-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        dismissAlert(alert);
                    });
                }
            });
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
