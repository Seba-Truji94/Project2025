{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Pedidos - Admin Dulce Bias{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header de Administración -->
    <div class="admin-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h3 mb-0">
                    <i class="fas fa-clipboard-list text-primary"></i>
                    Gestión de Pedidos
                </h1>
                <p class="text-muted mb-0">Panel de administración para gestionar todos los pedidos</p>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearModalBackdrop()" title="Limpiar vista si está difuminada">
                    <i class="fas fa-broom"></i> Limpiar Vista
                </button>
            </div>
        </div>
            <div class="col-auto">
                <button onclick="clearModalBackdrop()" class="btn btn-outline-warning btn-sm me-2" title="Limpiar página difuminada">
                    <i class="fas fa-broom"></i>
                    Limpiar Vista
                </button>
                <a href="{% url 'orders:admin_transfer_management' %}" class="btn btn-outline-info me-2">
                    <i class="fas fa-university"></i>
                    Transferencias
                </a>
                <a href="{% url 'orders:admin_statistics' %}" class="btn btn-outline-primary">
                    <i class="fas fa-chart-bar"></i>
                    Estadísticas
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="stat-card bg-primary">
                <div class="stat-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.total_orders }}</h3>
                    <p>Total Pedidos</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-warning">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.pending_orders }}</h3>
                    <p>Pendientes</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-success">
                <div class="stat-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.paid_orders }}</h3>
                    <p>Pagados</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-danger">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.unpaid_orders }}</h3>
                    <p>Sin Pagar</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-info">
                <div class="stat-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.processing_orders }}</h3>
                    <p>En Preparación</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-secondary">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.delivered_orders }}</h3>
                    <p>Entregados</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-2">
                    <label for="status" class="form-label">Estado</label>
                    <select name="status" id="status" class="form-select">
                        <option value="all" {% if current_filters.status == 'all' %}selected{% endif %}>Todos los Estados</option>
                        {% for value, display in status_choices %}
                            <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>
                                {{ display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="payment_status" class="form-label">Estado de Pago</label>
                    <select name="payment_status" id="payment_status" class="form-select">
                        <option value="all" {% if current_filters.payment_status == 'all' %}selected{% endif %}>Todos los Pagos</option>
                        {% for value, display in payment_status_choices %}
                            <option value="{{ value }}" {% if current_filters.payment_status == value %}selected{% endif %}>
                                {{ display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="search" class="form-label">Buscar</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           value="{{ current_filters.search }}" 
                           placeholder="Número, usuario, email...">
                </div>
                <div class="col-md-2">
                    <label for="date_from" class="form-label">Desde</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" 
                           value="{{ current_filters.date_from }}">
                </div>
                <div class="col-md-2">
                    <label for="date_to" class="form-label">Hasta</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" 
                           value="{{ current_filters.date_to }}">
                </div>
                <div class="col-md-1">
                    <label for="page_size" class="form-label">Mostrar</label>
                    <select name="page_size" id="page_size" class="form-select" onchange="this.form.submit()">
                        {% for option in page_size_options %}
                            <option value="{{ option.value }}" {% if current_filters.page_size == option.value %}selected{% endif %}>
                                {{ option.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Acciones Masivas -->
    <div class="card mb-4" id="bulk-actions" style="display: none;">
        <div class="card-body">
            <form method="post" action="{% url 'orders:admin_bulk_update_status' %}" class="row g-3">
                {% csrf_token %}
                <input type="hidden" name="order_ids" id="selected-order-ids">
                <div class="col-md-4">
                    <label for="new_status" class="form-label">Cambiar Estado a:</label>
                    <select name="new_status" id="new_status" class="form-select" required>
                        {% for value, display in status_choices %}
                            <option value="{{ value }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="bulk_notes" class="form-label">Notas (Opcional):</label>
                    <input type="text" name="notes" id="bulk_notes" class="form-control" 
                           placeholder="Notas para la actualización masiva">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-edit"></i>
                            Actualizar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Pedidos -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i>
                    Lista de Pedidos ({{ page_obj.paginator.count }} total)
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <!-- Selector de cantidad por página -->
                    <div class="d-flex align-items-center">
                        <label for="page_size_header" class="form-label me-2 mb-0 text-nowrap">Mostrar:</label>
                        <select name="page_size" id="page_size_header" class="form-select form-select-sm" 
                                onchange="changePageSize(this.value)" style="width: auto;">
                            {% for option in page_size_options %}
                                <option value="{{ option.value }}" {% if current_filters.page_size == option.value %}selected{% endif %}>
                                    {{ option.value }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Selección masiva -->
                    <div class="bulk-selection">
                        <input type="checkbox" id="select-all" class="form-check-input">
                        <label for="select-all" class="form-check-label ms-2">Seleccionar Todos</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if orders %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="40px">
                                    <input type="checkbox" id="header-checkbox" class="form-check-input">
                                </th>
                                <th>Pedido</th>
                                <th>Cliente</th>
                                <th>Estado</th>
                                <th>Estado Pago</th>
                                <th>Total</th>
                                <th>Fecha</th>
                                <th width="150px">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr class="order-row" data-order-id="{{ order.id }}">
                                <td>
                                    <input type="checkbox" class="form-check-input order-checkbox" 
                                           value="{{ order.id }}">
                                </td>
                                <td>
                                    <div class="order-info">
                                        <strong>#{{ order.order_number }}</strong>
                                        <br>
                                        <small class="text-muted">{{ order.get_total_items }} productos</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="customer-info">
                                        <strong>{{ order.full_name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ order.user.email }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge status-badge status-{{ order.status }}">
                                        {% if order.status == 'pending' %}
                                            <i class="fas fa-clock"></i> Pendiente
                                        {% elif order.status == 'confirmed' %}
                                            <i class="fas fa-check"></i> Confirmado
                                        {% elif order.status == 'processing' %}
                                            <i class="fas fa-cogs"></i> En Preparación
                                        {% elif order.status == 'shipped' %}
                                            <i class="fas fa-shipping-fast"></i> Enviado
                                        {% elif order.status == 'delivered' %}
                                            <i class="fas fa-check-circle"></i> Entregado
                                        {% elif order.status == 'cancelled' %}
                                            <i class="fas fa-times"></i> Cancelado
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge payment-badge payment-{{ order.payment_status }}">
                                        {% if order.payment_status == 'pending' %}
                                            <i class="fas fa-clock text-warning"></i> Pendiente
                                        {% elif order.payment_status == 'paid' %}
                                            <i class="fas fa-check-circle text-success"></i> Pagado
                                        {% elif order.payment_status == 'failed' %}
                                            <i class="fas fa-times-circle text-danger"></i> Fallido
                                        {% elif order.payment_status == 'refunded' %}
                                            <i class="fas fa-undo text-info"></i> Reembolsado
                                        {% endif %}
                                    </span>
                                    <br>
                                    <small class="text-muted">{{ order.get_payment_method_display }}</small>
                                </td>
                                <td>
                                    <strong>{{ order.formatted_total }}</strong>
                                </td>
                                <td>
                                    <div class="date-info">
                                        {{ order.created_at|date:"d/m/Y" }}
                                        <br>
                                        <small class="text-muted">{{ order.created_at|time:"H:i" }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group-vertical d-grid gap-1" role="group">
                                        <a href="{% url 'orders:admin_detail' order.order_number %}" 
                                           class="btn btn-sm btn-outline-primary" title="Ver Detalle">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-secondary quick-status-btn" 
                                                data-order-id="{{ order.id }}" 
                                                data-current-status="{{ order.status }}"
                                                title="Cambiar Estado">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if order.payment_status == 'pending' %}
                                            <button class="btn btn-sm btn-outline-success payment-btn" 
                                                    data-order-id="{{ order.id }}" 
                                                    data-action="mark_paid"
                                                    title="Marcar como Pagado">
                                                <i class="fas fa-credit-card"></i>
                                            </button>
                                        {% elif order.payment_status == 'paid' %}
                                            <button class="btn btn-sm btn-outline-warning payment-btn" 
                                                    data-order-id="{{ order.id }}" 
                                                    data-action="mark_unpaid"
                                                    title="Marcar como No Pagado">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                    <h5>No se encontraron pedidos</h5>
                    <p class="text-muted">No hay pedidos que coincidan con los filtros aplicados.</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Paginación -->
        {% if is_paginated %}
        <div class="card-footer">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="pagination-info">
                        <small class="text-muted">
                            Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} pedidos
                            ({{ current_filters.page_size }} por página)
                        </small>
                    </div>
                </div>
                <div class="col-md-6">
                    <nav aria-label="Paginación de pedidos">
                        <ul class="pagination justify-content-end mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                       title="Primera página">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                       title="Página anterior">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                                    </li>
                                {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                                    </li>
                                {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                       title="Página siguiente">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value and key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                       title="Última página">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card-footer">
            <div class="text-center">
                <small class="text-muted">
                    Total: {{ page_obj.paginator.count }} pedidos
                </small>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Cambio Rápido de Estado - Versión Sin Backdrop -->
<div class="custom-modal" id="quickStatusModal" style="display: none;">
    <div class="custom-modal-overlay"></div>
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Cambiar Estado del Pedido</h5>
                <button type="button" class="custom-close-btn" onclick="closeQuickModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <form id="quick-status-form">
                    {% csrf_token %}
                    <input type="hidden" id="modal-order-id">
                    <div class="mb-3">
                        <label for="modal-status" class="form-label">Nuevo Estado:</label>
                        <select id="modal-status" class="form-select" required>
                            {% for value, display in status_choices %}
                                <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modal-notes" class="form-label">Notas (Opcional):</label>
                        <textarea id="modal-notes" class="form-control" rows="3" 
                                  placeholder="Notas sobre el cambio de estado..."></textarea>
                    </div>
                </form>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeQuickModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-status-btn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal personalizado sin dependencia de Bootstrap */
.custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.custom-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease;
}

.custom-modal-dialog {
    position: relative;
    z-index: 10000;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.custom-modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
}

.custom-modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: between;
    align-items: center;
}

.custom-modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 500;
    flex-grow: 1;
}

.custom-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.custom-close-btn:hover {
    color: #000;
}

.custom-modal-body {
    padding: 1.5rem;
}

.custom-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        opacity: 0; 
        transform: scale(0.9) translateY(-50px); 
    }
    to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    }
}

.admin-header {
    background: linear-gradient(135deg, var(--primary-blue), var(--accent-pink));
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.stat-card {
    border-radius: 16px;
    padding: 1.8rem;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
    pointer-events: none;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
}

/* Colores pasteles difuminados */
.stat-card.bg-primary { 
    background: linear-gradient(135deg, rgba(116, 185, 255, 0.15), rgba(158, 158, 255, 0.1));
    border-left: 4px solid rgba(116, 185, 255, 0.6);
    color: #2563eb;
}

.stat-card.bg-warning { 
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 235, 59, 0.1));
    border-left: 4px solid rgba(255, 193, 7, 0.6);
    color: #f59e0b;
}

.stat-card.bg-info { 
    background: linear-gradient(135deg, rgba(23, 162, 184, 0.15), rgba(103, 232, 249, 0.1));
    border-left: 4px solid rgba(23, 162, 184, 0.6);
    color: #0891b2;
}

.stat-card.bg-secondary { 
    background: linear-gradient(135deg, rgba(108, 117, 125, 0.15), rgba(173, 181, 189, 0.1));
    border-left: 4px solid rgba(108, 117, 125, 0.6);
    color: #64748b;
}

.stat-card.bg-success { 
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.15), rgba(76, 217, 100, 0.1));
    border-left: 4px solid rgba(40, 167, 69, 0.6);
    color: #16a34a;
}

.stat-card.bg-danger { 
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.15), rgba(248, 113, 113, 0.1));
    border-left: 4px solid rgba(220, 53, 69, 0.6);
    color: #dc2626;
}

.stat-icon {
    font-size: 2.5rem;
    margin-right: 1.5rem;
    opacity: 0.8;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    transition: all 0.3s ease;
}

.stat-card:hover .stat-icon {
    opacity: 1;
    transform: scale(1.05);
}

.stat-content h3 {
    margin: 0;
    font-size: 2.2rem;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.stat-content p {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 500;
    opacity: 0.8;
    letter-spacing: 0.025em;
}

.stat-card:hover .stat-content h3 {
    transform: translateX(2px);
}

.stat-content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.status-badge {
    font-size: 0.8rem;
    padding: 0.5rem 0.75rem;
}

.status-pending { background-color: #ffc107; color: #212529; }
.status-confirmed { background-color: #17a2b8; color: white; }
.status-processing { background-color: #6f42c1; color: white; }
.status-shipped { background-color: #fd7e14; color: white; }
.status-delivered { background-color: #28a745; color: white; }
.status-cancelled { background-color: #dc3545; color: white; }

.payment-badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
    border-radius: 0.375rem;
}

.payment-pending { 
    background-color: #fff3cd; 
    color: #856404; 
    border: 1px solid #ffeaa7;
}

.payment-paid { 
    background-color: #d4edda; 
    color: #155724; 
    border: 1px solid #c3e6cb;
}

.payment-failed { 
    background-color: #f8d7da; 
    color: #721c24; 
    border: 1px solid #f5c6cb;
}

.payment-refunded { 
    background-color: #d1ecf1; 
    color: #0c5460; 
    border: 1px solid #bee5eb;
}

.order-row:hover {
    background-color: #f8f9fa;
}

.table th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.bulk-selection {
    font-size: 0.9rem;
}

#bulk-actions {
    border-left: 4px solid #ffc107;
}

/* Estilos para paginación mejorada */
.pagination-info {
    display: flex;
    align-items: center;
    height: 38px; /* Altura similar a los botones de paginación */
}

.page-link {
    border-radius: 6px;
    margin: 0 2px;
    transition: all 0.2s ease;
}

.page-link:hover {
    background-color: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
    transform: translateY(-1px);
}

.page-item.active .page-link {
    background-color: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
    font-weight: 600;
}

.page-item.disabled .page-link {
    color: #6c757d;
    background-color: #fff;
    border-color: #dee2e6;
}

/* Selector de página */
#page_size {
    font-size: 0.9rem;
}

/* Responsivo para paginación */
@media (max-width: 768px) {
    .pagination-info {
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .pagination {
        justify-content: center !important;
        flex-wrap: wrap;
    }
    
    .page-link {
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejo de selección múltiple
    const headerCheckbox = document.getElementById('header-checkbox');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    const bulkActionsDiv = document.getElementById('bulk-actions');
    const selectedOrderIds = document.getElementById('selected-order-ids');
    
    // Función para actualizar el estado de selección
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkedBoxes.length > 0) {
            bulkActionsDiv.style.display = 'block';
            const ids = Array.from(checkedBoxes).map(cb => cb.value);
            selectedOrderIds.value = ids.join(',');
        } else {
            bulkActionsDiv.style.display = 'none';
        }
    }
    
    // Seleccionar/deseleccionar todos
    headerCheckbox?.addEventListener('change', function() {
        orderCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
        updateBulkActions();
    });
    
    // Manejo individual de checkboxes
    orderCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateBulkActions);
    });
    
    // Cambio rápido de estado - Modal personalizado sin Bootstrap
    const quickStatusBtns = document.querySelectorAll('.quick-status-btn');
    const quickStatusModalElement = document.getElementById('quickStatusModal');
    
    // Funciones para el modal personalizado
    function openQuickModal(orderId, currentStatus) {
        document.getElementById('modal-order-id').value = orderId;
        document.getElementById('modal-status').value = currentStatus;
        document.getElementById('modal-notes').value = '';
        
        quickStatusModalElement.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    function closeQuickModal() {
        quickStatusModalElement.style.display = 'none';
        document.body.style.overflow = '';
        
        // Resetear formulario
        document.getElementById('modal-notes').value = '';
        const saveBtn = document.getElementById('save-status-btn');
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'Guardar Cambios';
    }
    
    // Event listeners para abrir modal
    quickStatusBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const currentStatus = this.dataset.currentStatus;
            openQuickModal(orderId, currentStatus);
        });
    });
    
    // Cerrar modal clickeando en overlay
    quickStatusModalElement.addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('custom-modal-overlay')) {
            closeQuickModal();
        }
    });
    
    // Cerrar modal con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && quickStatusModalElement.style.display === 'flex') {
            closeQuickModal();
        }
    });
    
    // Hacer funciones globales para acceso desde HTML
    window.openQuickModal = openQuickModal;
    window.closeQuickModal = closeQuickModal;
    
    // Guardar cambio de estado con modal personalizado
    document.getElementById('save-status-btn')?.addEventListener('click', function() {
        const orderId = document.getElementById('modal-order-id').value;
        const newStatus = document.getElementById('modal-status').value;
        const notes = document.getElementById('modal-notes').value;
        
        // Deshabilitar botón para evitar múltiples clicks
        const saveBtn = this;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        
        // Hacer petición AJAX para actualizar el estado
        fetch('/orders/admin/ajax/change-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                order_id: orderId,
                status: newStatus,
                notes: notes
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Cerrar modal inmediatamente
                closeQuickModal();
                
                // Mostrar mensaje de éxito
                showAlert('success', `<i class="fas fa-check-circle me-2"></i>${data.message || 'Estado actualizado correctamente'}`);
                
                // Actualizar el estado en la tabla sin recargar
                updateOrderRowStatus(orderId, newStatus, data.status_display);
                
            } else {
                throw new Error(data.error || 'Error al actualizar el estado');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Cerrar modal inmediatamente
            closeQuickModal();
            
            // Mostrar mensaje de error
            showAlert('danger', `<i class="fas fa-exclamation-triangle me-2"></i>Error al actualizar el estado: ${error.message}`);
        })
        .finally(() => {
            // Rehabilitar botón
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Guardar Cambios';
        });
    });
    
    // Funciones auxiliares
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss alert después de 4 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 4000);
    }
    
    function updateOrderRowStatus(orderId, newStatus, statusDisplay) {
        const orderRow = document.querySelector(`[data-order-id="${orderId}"]`)?.closest('tr');
        if (orderRow) {
            const statusCell = orderRow.querySelector('.badge');
            if (statusCell) {
                statusCell.textContent = statusDisplay || newStatus;
                statusCell.className = `badge bg-${getStatusClass(newStatus)}`;
            }
        }
    }
    
    // Gestión de pagos
    const paymentBtns = document.querySelectorAll('.payment-btn');
    
    paymentBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const action = this.dataset.action; // 'mark_paid' or 'mark_unpaid'
            
            // Confirmar acción
            const actionText = action === 'mark_paid' ? 'marcar como PAGADO' : 'marcar como NO PAGADO';
            const confirmMessage = `¿Estás seguro de que deseas ${actionText} este pedido?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Deshabilitar botón temporalmente
            const originalContent = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Determinar nuevo estado de pago
            const newPaymentStatus = action === 'mark_paid' ? 'paid' : 'pending';
            
            // Hacer petición AJAX
            fetch('/orders/admin/ajax/change-payment-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    order_id: orderId,
                    payment_status: newPaymentStatus,
                    action: action
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mostrar mensaje de éxito
                    const successIcon = action === 'mark_paid' ? 'check-circle' : 'exclamation-triangle';
                    showAlert('success', `<i class="fas fa-${successIcon} me-2"></i>${data.message}`);
                    
                    // Actualizar la interfaz
                    updatePaymentStatusDisplay(orderId, newPaymentStatus, action);
                    
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', `<i class="fas fa-exclamation-triangle me-2"></i>Error: ${error.message}`);
            })
            .finally(() => {
                // Restaurar botón
                this.disabled = false;
                this.innerHTML = originalContent;
            });
        });
    });
    
    function updatePaymentStatusDisplay(orderId, newPaymentStatus, action) {
        // Encontrar la fila del pedido
        const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
        if (!orderRow) return;
        
        // Actualizar la columna de estado de pago
        const paymentStatusCell = orderRow.children[4]; // Columna de estado de pago
        const badge = paymentStatusCell.querySelector('.payment-badge');
        
        if (badge) {
            // Actualizar clase y contenido del badge
            badge.className = `badge payment-badge payment-${newPaymentStatus}`;
            
            if (newPaymentStatus === 'paid') {
                badge.innerHTML = '<i class="fas fa-check-circle text-success"></i> Pagado';
            } else {
                badge.innerHTML = '<i class="fas fa-clock text-warning"></i> Pendiente';
            }
        }
        
        // Actualizar botón de acción
        const actionsCell = orderRow.children[7]; // Columna de acciones
        const paymentBtn = actionsCell.querySelector('.payment-btn');
        
        if (paymentBtn) {
            if (newPaymentStatus === 'paid') {
                // Cambiar a botón "marcar como no pagado"
                paymentBtn.className = 'btn btn-sm btn-outline-warning payment-btn';
                paymentBtn.dataset.action = 'mark_unpaid';
                paymentBtn.title = 'Marcar como No Pagado';
                paymentBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            } else {
                // Cambiar a botón "marcar como pagado"
                paymentBtn.className = 'btn btn-sm btn-outline-success payment-btn';
                paymentBtn.dataset.action = 'mark_paid';
                paymentBtn.title = 'Marcar como Pagado';
                paymentBtn.innerHTML = '<i class="fas fa-credit-card"></i>';
            }
        }
    }
    
    function getStatusClass(status) {
        const statusClasses = {
            'pending': 'warning',
            'confirmed': 'info', 
            'processing': 'primary',
            'shipped': 'secondary',
            'delivered': 'success',
            'cancelled': 'danger'
        };
        return statusClasses[status] || 'secondary';
    }
    
    // Función de emergencia simplificada
    window.clearModalBackdrop = function() {
        // Cerrar modal personalizado si está abierto
        if (quickStatusModalElement.style.display === 'flex') {
            closeQuickModal();
        }
        
        // Limpiar cualquier resto de Bootstrap modals
        const bootstrapBackdrops = document.querySelectorAll('.modal-backdrop');
        bootstrapBackdrops.forEach(backdrop => backdrop.remove());
        
        // Restaurar estado del body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        document.body.style.marginRight = '';
        
        showAlert('info', '<i class="fas fa-broom me-2"></i>Vista limpiada correctamente');
        console.log('Vista limpiada completamente');
    };
    
    // Función para cambiar el tamaño de página
    window.changePageSize = function(pageSize) {
        const url = new URL(window.location);
        url.searchParams.set('page_size', pageSize);
        url.searchParams.set('page', '1'); // Resetear a la primera página
        window.location.href = url.toString();
    };
    
    // Manejo del selector de página en filtros
    const pageSizeSelect = document.getElementById('page_size');
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', function() {
            // Mostrar indicador de carga
            const originalContent = this.innerHTML;
            this.disabled = true;
            
            // Crear elemento de loading
            const loadingOption = document.createElement('option');
            loadingOption.value = '';
            loadingOption.textContent = 'Cargando...';
            loadingOption.selected = true;
            this.appendChild(loadingOption);
            
            // Enviar formulario después de un breve delay para mostrar el loading
            setTimeout(() => {
                this.form.submit();
            }, 100);
        });
    }
    
    // Mejorar feedback visual en la paginación
    const paginationLinks = document.querySelectorAll('.pagination .page-link');
    paginationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (!this.closest('.page-item').classList.contains('active') && 
                !this.closest('.page-item').classList.contains('disabled')) {
                
                // Agregar estado de loading
                const spinner = document.createElement('i');
                spinner.className = 'fas fa-spinner fa-spin';
                spinner.style.fontSize = '0.8rem';
                
                const originalContent = this.innerHTML;
                this.innerHTML = '';
                this.appendChild(spinner);
                this.style.pointerEvents = 'none';
                
                // El navegador manejará la navegación
            }
        });
    });
});
</script>
{% endblock %}
