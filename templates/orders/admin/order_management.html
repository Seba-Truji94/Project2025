{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Pedidos - Admin Dulce Bias{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header de Administración -->
    <div class="admin-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h3 mb-0">
                    <i class="fas fa-clipboard-list text-primary"></i>
                    Gestión de Pedidos
                </h1>
                <p class="text-muted mb-0">Panel de administración para gestionar todos los pedidos</p>
            </div>
            <div class="col-auto">
                <a href="{% url 'orders:admin_statistics' %}" class="btn btn-outline-primary">
                    <i class="fas fa-chart-bar"></i>
                    Estadísticas
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="stat-card bg-primary">
                <div class="stat-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.total_orders }}</h3>
                    <p>Total Pedidos</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-warning">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.pending_orders }}</h3>
                    <p>Pendientes</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-info">
                <div class="stat-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.processing_orders }}</h3>
                    <p>En Preparación</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-secondary">
                <div class="stat-icon">
                    <i class="fas fa-shipping-fast"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.shipped_orders }}</h3>
                    <p>Enviados</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card bg-success">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.delivered_orders }}</h3>
                    <p>Entregados</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="status" class="form-label">Estado</label>
                    <select name="status" id="status" class="form-select">
                        <option value="all" {% if current_filters.status == 'all' %}selected{% endif %}>Todos los Estados</option>
                        {% for value, display in status_choices %}
                            <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>
                                {{ display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="search" class="form-label">Buscar</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           value="{{ current_filters.search }}" 
                           placeholder="Número, usuario, email...">
                </div>
                <div class="col-md-2">
                    <label for="date_from" class="form-label">Desde</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" 
                           value="{{ current_filters.date_from }}">
                </div>
                <div class="col-md-2">
                    <label for="date_to" class="form-label">Hasta</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" 
                           value="{{ current_filters.date_to }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Acciones Masivas -->
    <div class="card mb-4" id="bulk-actions" style="display: none;">
        <div class="card-body">
            <form method="post" action="{% url 'orders:admin_bulk_update_status' %}" class="row g-3">
                {% csrf_token %}
                <input type="hidden" name="order_ids" id="selected-order-ids">
                <div class="col-md-4">
                    <label for="new_status" class="form-label">Cambiar Estado a:</label>
                    <select name="new_status" id="new_status" class="form-select" required>
                        {% for value, display in status_choices %}
                            <option value="{{ value }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="bulk_notes" class="form-label">Notas (Opcional):</label>
                    <input type="text" name="notes" id="bulk_notes" class="form-control" 
                           placeholder="Notas para la actualización masiva">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-edit"></i>
                            Actualizar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Pedidos -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i>
                    Lista de Pedidos ({{ page_obj.paginator.count }} total)
                </h5>
                <div class="bulk-selection">
                    <input type="checkbox" id="select-all" class="form-check-input">
                    <label for="select-all" class="form-check-label ms-2">Seleccionar Todos</label>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if orders %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="40px">
                                    <input type="checkbox" id="header-checkbox" class="form-check-input">
                                </th>
                                <th>Pedido</th>
                                <th>Cliente</th>
                                <th>Estado</th>
                                <th>Total</th>
                                <th>Fecha</th>
                                <th width="120px">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr class="order-row" data-order-id="{{ order.id }}">
                                <td>
                                    <input type="checkbox" class="form-check-input order-checkbox" 
                                           value="{{ order.id }}">
                                </td>
                                <td>
                                    <div class="order-info">
                                        <strong>#{{ order.order_number }}</strong>
                                        <br>
                                        <small class="text-muted">{{ order.get_total_items }} productos</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="customer-info">
                                        <strong>{{ order.full_name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ order.user.email }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge status-badge status-{{ order.status }}">
                                        {% if order.status == 'pending' %}
                                            <i class="fas fa-clock"></i> Pendiente
                                        {% elif order.status == 'confirmed' %}
                                            <i class="fas fa-check"></i> Confirmado
                                        {% elif order.status == 'processing' %}
                                            <i class="fas fa-cogs"></i> En Preparación
                                        {% elif order.status == 'shipped' %}
                                            <i class="fas fa-shipping-fast"></i> Enviado
                                        {% elif order.status == 'delivered' %}
                                            <i class="fas fa-check-circle"></i> Entregado
                                        {% elif order.status == 'cancelled' %}
                                            <i class="fas fa-times"></i> Cancelado
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <strong>{{ order.formatted_total }}</strong>
                                    {% if order.payment_status == 'paid' %}
                                        <br><small class="text-success">Pagado</small>
                                    {% else %}
                                        <br><small class="text-warning">{{ order.get_payment_status_display }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="date-info">
                                        {{ order.created_at|date:"d/m/Y" }}
                                        <br>
                                        <small class="text-muted">{{ order.created_at|time:"H:i" }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'orders:admin_detail' order.order_number %}" 
                                           class="btn btn-sm btn-outline-primary" title="Ver Detalle">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-secondary quick-status-btn" 
                                                data-order-id="{{ order.id }}" 
                                                data-current-status="{{ order.status }}"
                                                title="Cambio Rápido">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                    <h5>No se encontraron pedidos</h5>
                    <p class="text-muted">No hay pedidos que coincidan con los filtros aplicados.</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Paginación -->
        {% if is_paginated %}
        <div class="card-footer">
            <nav aria-label="Paginación de pedidos">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Primera</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Anterior</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Siguiente</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Última</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Cambio Rápido de Estado -->
<div class="modal fade" id="quickStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Estado del Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quick-status-form">
                    {% csrf_token %}
                    <input type="hidden" id="modal-order-id">
                    <div class="mb-3">
                        <label for="modal-status" class="form-label">Nuevo Estado:</label>
                        <select id="modal-status" class="form-select" required>
                            {% for value, display in status_choices %}
                                <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modal-notes" class="form-label">Notas (Opcional):</label>
                        <textarea id="modal-notes" class="form-control" rows="3" 
                                  placeholder="Notas sobre el cambio de estado..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-status-btn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<style>
.admin-header {
    background: linear-gradient(135deg, var(--primary-blue), var(--accent-pink));
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}

.stat-card.bg-primary { border-left: 4px solid var(--primary-blue); }
.stat-card.bg-warning { border-left: 4px solid #ffc107; }
.stat-card.bg-info { border-left: 4px solid #17a2b8; }
.stat-card.bg-secondary { border-left: 4px solid #6c757d; }
.stat-card.bg-success { border-left: 4px solid #28a745; }

.stat-icon {
    font-size: 2rem;
    margin-right: 1rem;
    opacity: 0.7;
}

.stat-content h3 {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
}

.stat-content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.status-badge {
    font-size: 0.8rem;
    padding: 0.5rem 0.75rem;
}

.status-pending { background-color: #ffc107; color: #212529; }
.status-confirmed { background-color: #17a2b8; color: white; }
.status-processing { background-color: #6f42c1; color: white; }
.status-shipped { background-color: #fd7e14; color: white; }
.status-delivered { background-color: #28a745; color: white; }
.status-cancelled { background-color: #dc3545; color: white; }

.order-row:hover {
    background-color: #f8f9fa;
}

.table th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
}

.bulk-selection {
    font-size: 0.9rem;
}

#bulk-actions {
    border-left: 4px solid #ffc107;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejo de selección múltiple
    const headerCheckbox = document.getElementById('header-checkbox');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    const bulkActionsDiv = document.getElementById('bulk-actions');
    const selectedOrderIds = document.getElementById('selected-order-ids');
    
    // Función para actualizar el estado de selección
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
        if (checkedBoxes.length > 0) {
            bulkActionsDiv.style.display = 'block';
            const ids = Array.from(checkedBoxes).map(cb => cb.value);
            selectedOrderIds.value = ids.join(',');
        } else {
            bulkActionsDiv.style.display = 'none';
        }
    }
    
    // Seleccionar/deseleccionar todos
    headerCheckbox?.addEventListener('change', function() {
        orderCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
        updateBulkActions();
    });
    
    // Manejo individual de checkboxes
    orderCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateBulkActions);
    });
    
    // Cambio rápido de estado
    const quickStatusBtns = document.querySelectorAll('.quick-status-btn');
    const quickStatusModal = new bootstrap.Modal(document.getElementById('quickStatusModal'));
    
    quickStatusBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const currentStatus = this.dataset.currentStatus;
            
            document.getElementById('modal-order-id').value = orderId;
            document.getElementById('modal-status').value = currentStatus;
            
            quickStatusModal.show();
        });
    });
    
    // Guardar cambio de estado
    document.getElementById('save-status-btn')?.addEventListener('click', function() {
        const orderId = document.getElementById('modal-order-id').value;
        const newStatus = document.getElementById('modal-status').value;
        const notes = document.getElementById('modal-notes').value;
        
        // Aquí harías la petición AJAX para actualizar el estado
        fetch(`/orders/admin/update-status/${orderId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                status: newStatus,
                status_notes: notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Recargar la página para ver los cambios
            } else {
                alert('Error al actualizar el estado');
            }
        });
        
        quickStatusModal.hide();
    });
});
</script>
{% endblock %}
