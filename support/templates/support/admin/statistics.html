{% extends 'base.html' %}
{% load static %}

{% block title %}Estadísticas de Soporte - Admin{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .admin-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        text-align: center;
    }
    .stats-number {
        font-size: 3rem;
        font-weight: bold;
        color: #007bff;
    }
    .stats-label {
        color: #6c757d;
        font-size: 1.1rem;
        margin-top: 0.5rem;
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .chart-container canvas {
        max-height: 400px !important;
        width: 100% !important;
    }
    .monthly-chart-container {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        height: 450px;
    }
    .monthly-chart-container canvas {
        max-height: 350px !important;
        width: 100% !important;
    }
    .table-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <a href="{% url 'support:admin_management' %}" class="btn btn-outline-light me-3">
                        <i class="fas fa-arrow-left"></i> Volver al Admin
                    </a>
                    <div>
                        <h1><i class="fas fa-chart-bar"></i> Estadísticas de Soporte</h1>
                        <p class="mb-0">Análisis detallado del sistema de soporte</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light" onclick="window.print()">
                    <i class="fas fa-print"></i> Imprimir Reporte
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Estadísticas Generales -->
    <div class="row">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ total_tickets }}</div>
                <div class="stats-label">Total Tickets</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-warning">{{ open_tickets_count|default:0 }}</div>
                <div class="stats-label">Tickets Abiertos</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-info">{{ in_progress_tickets_count|default:0 }}</div>
                <div class="stats-label">En Progreso</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-success">{{ resolved_tickets_count|default:0 }}</div>
                <div class="stats-label">Resueltos</div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row">
        <!-- Gráfico de Estados -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3"><i class="fas fa-pie-chart"></i> Distribución por Estados</h5>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        
        <!-- Gráfico de Prioridades -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3"><i class="fas fa-exclamation-triangle"></i> Distribución por Prioridad</h5>
                <canvas id="priorityChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gráfico de Tendencia Mensual -->
    <div class="row">
        <div class="col-12">
            <div class="monthly-chart-container">
                <h5 class="mb-3"><i class="fas fa-line-chart"></i> Tendencia de Tickets (Últimos 6 Meses)</h5>
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tablas de Datos -->
    <div class="row">
        <!-- Tickets por Categoría -->
        <div class="col-md-6">
            <div class="table-card">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-tags"></i> Tickets por Categoría</h6>
                </div>
                <div class="card-body p-0">
                    {% if category_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Categoría</th>
                                    <th class="text-end">Tickets</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in category_stats %}
                                <tr>
                                    <td>{{ stat.category__name|default:"Sin categoría" }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">{{ stat.count }}</span>
                                    </td>
                                    <td class="text-end">
                                        {% if total_tickets > 0 %}
                                        {% widthratio stat.count total_tickets 100 %}%
                                        {% else %}
                                        0%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox text-muted fa-2x mb-2"></i>
                        <p class="text-muted">No hay datos disponibles</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Estados Detallados -->
        <div class="col-md-6">
            <div class="table-card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-tasks"></i> Estados Detallados</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Estado</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for status, count in status_stats.items %}
                                <tr>
                                    <td>{{ status }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-info">{{ count }}</span>
                                    </td>
                                    <td class="text-end">
                                        {% if total_tickets > 0 %}
                                        {% widthratio count total_tickets 100 %}%
                                        {% else %}
                                        0%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Información Adicional -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Información del Reporte</h6>
                <ul class="mb-0">
                    <li><strong>Fecha de generación:</strong> {{ "now"|date:"d/m/Y H:i" }}</li>
                    <li><strong>Total de tickets:</strong> {{ total_tickets }}</li>
                    <li><strong>Período analizado:</strong> Últimos 6 meses</li>
                    <li><strong>Sistema:</strong> Galletas Kati - Soporte</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Django Template JavaScript - This file contains Django template syntax -->
<script type="text/javascript">
// Función principal que se ejecuta al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si los elementos de gráficos existen antes de crear
    const statusChart = document.getElementById('statusChart');
    const priorityChart = document.getElementById('priorityChart');
    const monthlyChart = document.getElementById('monthlyChart');
    
    // Configuración común para todos los gráficos
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    };
    
    // Gráfico de estados (doughnut)
    if (statusChart) {
        const statusConfig = {
            type: 'doughnut',
            data: {
                labels: [
                    {% for status, count in status_stats.items %}
                        '{{ status }}'{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    data: [
                        {% for status, count in status_stats.items %}
                            {{ count }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ]
                }]
            },
            options: commonOptions
        };
        new Chart(statusChart, statusConfig);
    }
    
    // Gráfico de prioridades (pie)
    if (priorityChart) {
        const priorityConfig = {
            type: 'pie',
            data: {
                labels: [
                    {% for priority, count in priority_stats.items %}
                        '{{ priority }}'{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    data: [
                        {% for priority, count in priority_stats.items %}
                            {{ count }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: ['#FF6384', '#FFCE56', '#4BC0C0']
                }]
            },
            options: commonOptions
        };
        new Chart(priorityChart, priorityConfig);
    }
    
    // Gráfico mensual (línea)
    if (monthlyChart) {
        const monthlyConfig = {
            type: 'line',
            data: {
                labels: [
                    {% for stat in monthly_stats %}
                        '{{ stat.month }}'{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Tickets Creados',
                    data: [
                        {% for stat in monthly_stats %}
                            {{ stat.count }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4
                }]
            },
            options: Object.assign({}, commonOptions, {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            })
        };
        new Chart(monthlyChart, monthlyConfig);
    }
});
</script>
{% endblock %}
