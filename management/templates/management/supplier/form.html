{% extends "management/base.html" %}
{% load static %}

{% block title %}{% if object %}Editar Proveedor{% else %}Crear Proveedor{% endif %} - Galletas Kati{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .form-group label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 8px;
    }
    
    .form-control {
        border-radius: 8px;
        border: 2px solid #e3e6f0;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    .btn-custom {
        border-radius: 8px;
        padding: 12px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .section-title {
        color: #5a5c69;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e3e6f0;
    }
    
    .help-text {
        font-size: 0.875em;
        color: #858796;
        margin-top: 5px;
    }
    
    .preview-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .preview-name {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .preview-contact {
        margin-bottom: 8px;
        opacity: 0.9;
    }
    
    .rating-input {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .rating-stars {
        display: flex;
        gap: 5px;
    }
    
    .rating-star {
        font-size: 1.5em;
        color: #ddd;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .rating-star:hover,
    .rating-star.active {
        color: #f6c23e;
    }
    
    .tips-card {
        background: #f8f9fc;
        border-left: 4px solid #4e73df;
        border-radius: 0 8px 8px 0;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-{% if object %}edit{% else %}plus{% endif %} text-primary"></i>
            {% if object %}Editar Proveedor: {{ object.name }}{% else %}Nuevo Proveedor{% endif %}
        </h1>
        <a href="{% url 'management:supplier_management' %}" class="btn btn-secondary btn-custom">
            <i class="fas fa-arrow-left"></i> Volver a la Lista
        </a>
    </div>

    <div class="row">
        <!-- Formulario -->
        <div class="col-lg-8">
            <div class="form-container">
                <form method="post" id="supplier-form">
                    {% csrf_token %}
                    
                    <!-- Información Básica -->
                    <h4 class="section-title">
                        <i class="fas fa-building"></i> Información Básica
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="id_name">Nombre de la Empresa *</label>
                                {{ form.name }}
                                <div class="help-text">Razón social o nombre comercial del proveedor</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_tax_id">RUT/NIT</label>
                                {{ form.tax_id }}
                                <div class="help-text">Identificación tributaria</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_contact_person">Persona de Contacto</label>
                        {{ form.contact_person }}
                        <div class="help-text">Nombre del representante o contacto principal</div>
                    </div>
                    
                    <!-- Información de Contacto -->
                    <h4 class="section-title">
                        <i class="fas fa-address-book"></i> Información de Contacto
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_email">Correo Electrónico</label>
                                {{ form.email }}
                                <div class="help-text">Email principal para comunicaciones</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_phone">Teléfono</label>
                                {{ form.phone }}
                                <div class="help-text">Número de contacto principal</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dirección -->
                    <h4 class="section-title">
                        <i class="fas fa-map-marker-alt"></i> Dirección
                    </h4>
                    
                    <div class="form-group">
                        <label for="id_address">Dirección Completa</label>
                        {{ form.address }}
                        <div class="help-text">Calle, número, comuna, código postal</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_city">Ciudad</label>
                        {{ form.city }}
                        <div class="help-text">Ciudad donde está ubicado el proveedor</div>
                    </div>
                    
                    <!-- Evaluación y Estado -->
                    <h4 class="section-title">
                        <i class="fas fa-star"></i> Evaluación y Estado
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_rating">Calificación</label>
                                <div class="rating-input">
                                    {{ form.rating }}
                                    <div class="rating-stars" id="rating-stars">
                                        {% for i in "12345" %}
                                        <i class="fas fa-star rating-star" data-rating="{{ forloop.counter }}"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="help-text">Calificación del 1 al 5 basada en el desempeño</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="custom-control custom-switch mt-4">
                                    {{ form.is_active }}
                                    <label class="custom-control-label" for="id_is_active">
                                        <strong>Proveedor Activo</strong>
                                    </label>
                                </div>
                                <div class="help-text">Solo los proveedores activos aparecen en las listas de selección</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notas -->
                    <h4 class="section-title">
                        <i class="fas fa-sticky-note"></i> Notas y Observaciones
                    </h4>
                    
                    <div class="form-group">
                        <label for="id_notes">Notas Internas</label>
                        {{ form.notes }}
                        <div class="help-text">Comentarios, condiciones especiales, historial, etc.</div>
                    </div>
                    
                    <!-- Botones -->
                    <div class="form-group mt-4">
                        <button type="submit" class="btn btn-primary btn-custom mr-3">
                            <i class="fas fa-save"></i>
                            {% if object %}Actualizar Proveedor{% else %}Crear Proveedor{% endif %}
                        </button>
                        <a href="{% url 'management:supplier_management' %}" class="btn btn-secondary btn-custom">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Vista Previa y Consejos -->
        <div class="col-lg-4">
            <!-- Vista Previa -->
            <div class="preview-card">
                <h5><i class="fas fa-eye"></i> Vista Previa</h5>
                <div class="preview-name" id="preview-name">Nombre del Proveedor</div>
                <div class="preview-contact" id="preview-contact">
                    <i class="fas fa-user"></i> Persona de contacto
                </div>
                <div class="preview-contact" id="preview-email">
                    <i class="fas fa-envelope"></i> email@ejemplo.com
                </div>
                <div class="preview-contact" id="preview-phone">
                    <i class="fas fa-phone"></i> +56 9 1234 5678
                </div>
                <div class="preview-contact" id="preview-address">
                    <i class="fas fa-map-marker-alt"></i> Dirección completa
                </div>
                
                <div class="mt-3">
                    <div id="preview-rating">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                </div>
            </div>
            
            <!-- Consejos -->
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-lightbulb"></i> Consejos para Proveedores
                    </h6>
                </div>
                <div class="card-body">
                    <div class="tips-card">
                        <h6 class="text-primary mb-3">Información Completa</h6>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                Incluye todos los datos de contacto
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                Verifica la información tributaria
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                Mantén las calificaciones actualizadas
                            </li>
                            <li class="mb-0">
                                <i class="fas fa-check text-success"></i>
                                Documenta condiciones especiales
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Estadísticas (si es edición) -->
            {% if object %}
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-chart-bar"></i> Estadísticas
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h4 mb-0 text-primary">0</div>
                            <small class="text-muted">Productos</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-0 text-success">0</div>
                            <small class="text-muted">Pedidos</small>
                        </div>
                        <div class="col-4">
                            <div class="h4 mb-0 text-info">{{ object.created_at|timesince }}</div>
                            <small class="text-muted">Registrado</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updatePreview() {
        // Obtener valores del formulario
        const name = document.getElementById('id_name').value || 'Nombre del Proveedor';
        const contact = document.getElementById('id_contact_person').value || 'Persona de contacto';
        const email = document.getElementById('id_email').value || 'email@ejemplo.com';
        const phone = document.getElementById('id_phone').value || '+56 9 1234 5678';
        const address = document.getElementById('id_address').value || 'Dirección completa';
        const city = document.getElementById('id_city').value;
        const rating = document.getElementById('id_rating').value || 5;
        
        // Actualizar vista previa
        document.getElementById('preview-name').textContent = name;
        document.getElementById('preview-contact').innerHTML = '<i class="fas fa-user"></i> ' + contact;
        document.getElementById('preview-email').innerHTML = '<i class="fas fa-envelope"></i> ' + email;
        document.getElementById('preview-phone').innerHTML = '<i class="fas fa-phone"></i> ' + phone;
        
        let fullAddress = address;
        if (city) {
            fullAddress += ', ' + city;
        }
        document.getElementById('preview-address').innerHTML = '<i class="fas fa-map-marker-alt"></i> ' + fullAddress;
        
        // Actualizar calificación
        updateRatingDisplay(rating);
    }
    
    function updateRatingDisplay(rating) {
        const ratingContainer = document.getElementById('preview-rating');
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                stars += '<i class="fas fa-star" style="color: #f6c23e;"></i>';
            } else {
                stars += '<i class="far fa-star" style="color: #ddd;"></i>';
            }
        }
        ratingContainer.innerHTML = stars;
        
        // Actualizar estrellas del formulario
        const formStars = document.querySelectorAll('.rating-star');
        formStars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }
    
    // Event listeners para estrellas de calificación
    function setupRatingStars() {
        const stars = document.querySelectorAll('.rating-star');
        const ratingInput = document.getElementById('id_rating');
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.dataset.rating;
                ratingInput.value = rating;
                updateRatingDisplay(rating);
            });
            
            star.addEventListener('mouseenter', function() {
                const rating = this.dataset.rating;
                stars.forEach((s, index) => {
                    if (index < rating) {
                        s.style.color = '#f6c23e';
                    } else {
                        s.style.color = '#ddd';
                    }
                });
            });
        });
        
        document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
            const currentRating = ratingInput.value || 0;
            updateRatingDisplay(currentRating);
        });
    }
    
    // Validación del formulario
    function validateForm() {
        const name = document.getElementById('id_name').value.trim();
        
        if (!name) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'El nombre del proveedor es requerido'
            });
            return false;
        }
        
        const email = document.getElementById('id_email').value;
        if (email && !isValidEmail(email)) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor ingresa un email válido'
            });
            return false;
        }
        
        return true;
    }
    
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Campos que afectan la vista previa
        const fields = ['id_name', 'id_contact_person', 'id_email', 'id_phone', 'id_address', 'id_city', 'id_rating'];
        
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', updatePreview);
                field.addEventListener('change', updatePreview);
            }
        });
        
        // Configurar estrellas de calificación
        setupRatingStars();
        
        // Actualizar vista previa inicial
        updatePreview();
        
        // Validación del formulario
        document.getElementById('supplier-form').addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
            }
        });
        
        // Animación de entrada
        const formContainer = document.querySelector('.form-container');
        formContainer.style.opacity = '0';
        formContainer.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            formContainer.style.transition = 'all 0.5s ease';
            formContainer.style.opacity = '1';
            formContainer.style.transform = 'translateY(0)';
        }, 100);
    });
</script>
{% endblock %}
